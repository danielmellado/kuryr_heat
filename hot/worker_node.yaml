heat_template_version: 2014-10-16

description: Template to deploy openshift worker nodes

parameters:
  image:
    type: string
    label: Image name or ID
    description: Image to be used for the kuryr nodes
  flavor:
    type: string
    label: Flavor
    description: Flavor to be used for the image
    default: m1.small
  key:
    type: string
    label: key name
    description: Keypair to be used for the instance
  index:
    type: number
  name:
    type: string
    label: Instance name
    description: Worker node instance name
  network:
    type: string
    label: VM Network
    description: Neutron network for VMs
  subnet:
    type: string
    label: VM Subnet
    description: Neutron subnet for VMs

resources:
  parent_port:
    type: OS::Neutron::Port
    properties:
      name: { get_param: name }
      network: { get_param: network }
      security_groups:
        - default
      fixed_ips:
        - subnet: { get_param: subnet }

  trunk_port:
    type: OS::Neutron::Trunk
    properties:
      name: { get_param: name }
      port: { get_resource: parent_port }

  instance:
    type: OS::Nova::Server
    properties:
      image: { get_param: image }
      flavor: { get_param: flavor }
      key_name: { get_param: key }
      name: { get_param: name }
      networks:
          - port: { get_attr: [trunk_port, port_id] }

outputs:
  trunk_port_id:
    value: { get_resource: parent_port }
  trunk_port_ips:
    value: { get_attr: [parent_port, fixed_ips] }
  trunk_port_dns:
    value: { get_attr: [parent_port, dns_assignment] }
